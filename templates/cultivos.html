<!-- cultivos.html actualizado -->
{% extends "base.html" %}

{% block content %}
<div class="cultivos-main">
  <div class="cultivos-header">
    <h1 class="cultivos-title">
      <span class="title-icon">🌱</span>
      <span>Mis Cultivos</span>
    </h1>
    <button class="btn-add" id="addPlantBtn" data-tooltip="Agregar nuevo cultivo">
      <span class="btn-icon">+</span>
      <span class="btn-text">Nuevo Cultivo</span>
    </button>
  </div>
  
  <div class="plants-grid" id="plant-list">
    {% for plant in user.plants %}
    <div class="plant-card" data-plant-id="{{ plant.id }}">
      <div class="plant-header">
        <h3 class="plant-name">{{ plant.name }}</h3>
        <span class="plant-status" data-status="active">
          <span class="status-icon">🌿</span>
          <span class="status-text">Activo</span>
        </span>
      </div>
      
      <div class="plant-metrics">
        <div class="metric-item" data-tooltip="Humedad necesaria para un crecimiento óptimo">
          <div class="metric-icon">💧</div>
          <div class="metric-info">
            <div class="metric-value">{{ plant.humidity_required }}%</div>
            <div class="metric-label">Humedad Requerida</div>
          </div>
        </div>
        
        <div class="metric-item" data-tooltip="Temperatura actual del ambiente">
          <div class="metric-icon">🌡️</div>
          <div class="metric-info">
            <div class="metric-value">24°C</div>
            <div class="metric-label">Temperatura Actual</div>
          </div>
        </div>
      </div>
      
      <div class="plant-actions">
        <button class="action-btn edit-btn" data-tooltip="Editar cultivo">
          <span class="btn-icon">✏️</span>
          <span class="btn-text">Editar</span>
        </button>
        <button class="action-btn delete-btn" data-tooltip="Eliminar cultivo">
          <span class="btn-icon">🗑️</span>
          <span class="btn-text">Eliminar</span>
        </button>
      </div>
    </div>
    {% else %}
    <div class="empty-state">
      <img src="{{ url_for('static', filename='images/empty.svg') }}" alt="Sin cultivos" class="empty-image">
      <p class="empty-text">Aún no tienes cultivos registrados</p>
      <button class="btn-add" onclick="document.getElementById('addPlantBtn').click()">
        <span class="btn-icon">+</span>
        <span class="btn-text">Agregar mi primer cultivo</span>
      </button>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Modal para agregar cultivo -->
<div id="addPlantModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Agregar Nuevo Cultivo</h2>
        <form id="plantForm">
            <div class="form-group">
                <label for="plantName">Nombre de la huerta 🌱</label>
                <input type="text" id="plantName" required>
            </div>
            
            <div class="form-group">
                <label for="valveName">Nombre de válvula</label>
                <input type="text" id="valveName" required>
            </div>
            
            <div class="form-group">
                <label for="sensors">Cantidad de sensores</label>
                <input type="number" id="sensors" min="1" required>
            </div>
            
            <div class="form-group">
                <label for="plants">Cantidad de plantas 🌿</label>
                <input type="number" id="plants" min="1" required>
            </div>
            
            <div class="form-group">
                <label for="sensorType">Tipo de sensor</label>
                <select id="sensorType" required>
                    <option value="" disabled selected>Selecciona un sensor</option>
                    <option value="temperature">Temperatura 🌡️</option>
                    <option value="humidity">Humedad 💧</option>
                    <option value="ph">Nivel de pH 🧪</option>
                </select>
            </div>
            
            <button type="submit" id="submitPlantBtn">Crear Cultivo</button>
        </form>
    </div>
</div>

<script>
  // Animación mejorada para el modal
  const modal = document.getElementById('addPlantModal');
  const openModal = () => {
    modal.style.display = 'flex';
    modal.classList.add('show');
  }

  const closeModal = () => {
    modal.classList.remove('show');
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
  }

  document.querySelector('.close').addEventListener('click', closeModal);
  window.addEventListener('click', (e) => e.target === modal && closeModal());
  document.getElementById('addPlantBtn').addEventListener('click', openModal);

  // Mejor manejo del formulario
  document.getElementById('plantForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
      name: document.getElementById('plantName').value,
      humidity_required: document.getElementById('valveName').value,
      // Agrega aquí los demás campos
    };

    try {
      const response = await fetch('/api/plants', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });
      
      if (response.ok) {
        closeModal();
        location.reload();
      } else {
        alert('Error al guardar el cultivo');
      }
    } catch (error) {
      console.error('Error:', error);
    }
  });
</script>
{% endblock %}